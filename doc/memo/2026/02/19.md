# Developed by copilot(自分で開発してない)
# 2026-02-19 チケット8「フロント統合タスク」作業記録

## 本日取り組んだタスク

**チケット8「フロント統合タスク - ストア統合とAPI共通化」** の実装完了


### 実装内容

#### 1. useAuthStore.ts の拡張（認証ロジックの一元化）

**追加機能：**
- `login(email, password)` 関数
  - API呼び出しからトークン/ユーザー情報の保存まで一元管理
  - 成功時に自動的に `localStorage` とストアに保存
  - エラー時は呼び出し元にthrow
  
- `register(name, email, password)` 関数
  - ユーザー登録API呼び出し
  - 登録後は自動ログインしない設計（セキュリティ・UX観点）

**変更ファイル：**
- [frontend/store/useAuthStore.ts](frontend/store/useAuthStore.ts)

#### 2. api.ts の共通化（認証ヘッダの自動付与）

**追加機能：**
- `fetchWithAuth(url, options)` 関数
  - localStorage からトークンを自動取得して Authorization ヘッダに付与
  - 401エラー時は自動的にログアウトを実行（セキュリティ強化）
  - 循環参照を回避するため動的インポートを使用

- `register(name, email, password)` 関数
  - 新規ユーザー登録API
  - エラーハンドリングの統一

**変更内容：**
- `createProduct(product)` を `fetchWithAuth` を使用するように修正
  - トークンを手動で渡す必要がなくなった（DX向上）
  
- `login(email, password)` のエラーハンドリング改善
  - Error オブジェクトとして properly な形でthrow

**変更ファイル：**
- [frontend/lib/api.ts](frontend/lib/api.ts)

#### 3. login/page.tsx の簡素化

**変更前：**
```typescript
const res = await login(email, password);
setToken(res.token);
setUser(res.user);
localStorage.setItem("auth_user", JSON.stringify(res.user));
```

**変更後：**
```typescript
await useAuthStore.getState().login(email, password);
```

**効果：**
- コードが3行から1行に削減
- ログイン処理の詳細がストアに隠蔽され、保守性向上

**変更ファイル：**
- [frontend/app/login/page.tsx](frontend/app/login/page.tsx)

#### 4. テストコード追加（TDDサイクル）

**新規テストファイル：**
- [frontend/lib/__tests__/api.fetchWithAuth.test.ts](frontend/lib/__tests__/api.fetchWithAuth.test.ts)
  - ✅ トークンあり: Authorization ヘッダが自動付与される
  - ✅ トークンなし: Authorization ヘッダが付与されない
  - ✅ 401エラー: 自動ログアウトが実行される
  - ✅ 正常系: レスポンスを返す

**拡張テスト：**
- [frontend/lib/__tests__/useAuthStore.test.ts](frontend/lib/__tests__/useAuthStore.test.ts)
  - `login` 関数のテスト (3ケース)
    - ✅ 正常系: ログイン成功でトークンとユーザー情報が保存される
    - ✅ 異常系: 401エラーでエラーがthrowされる
    - ✅ 異常系: network errorでエラーがthrowされる
  - `register` 関数のテスト (2ケース)
    - ✅ 正常系: 登録成功でAPIが呼ばれる
    - ✅ 異常系: 400エラー（重複メール等）でエラーがthrowされる

**修正テスト：**
- [frontend/lib/__tests__/page.test.tsx](frontend/lib/__tests__/page.test.tsx)
  - 新しい実装に合わせてモックを修正
  - `useAuthStore.login` を使用するように変更

#### 5. テスト実行結果

```
Test Suites: 5 passed, 5 total
Tests:       17 passed, 17 total
Snapshots:   0 total
Time:        2.66 s
```

**✅ 全テストPASS**
**✅ コンパイルエラーなし**

---

## TDDサイクルの実践

### Red（失敗するテストを書く）
1. `useAuthStore.test.ts` に `login`/`register` のテストケースを追加
2. `api.fetchWithAuth.test.ts` を新規作成
3. テスト実行 → 関数が未実装のため失敗

### Green（テストをパスする最小限の実装）
1. `useAuthStore.ts` に `login`/`register` 関数を追加
2. `api.ts` に `fetchWithAuth` と `register` 関数を追加
3. `createProduct` を `fetchWithAuth` を使用するように修正
4. `login/page.tsx` をストアの `login` を使用するように修正
5. テスト実行 → 1つ失敗（401エラーハンドリング）
6. `api.login` のエラーハンドリングを修正 → 全テストPASS

### Refactor（リファクタリング）
1. TypeScriptの型エラー修正（HeadersInit → Record<string, string>）
2. `page.test.tsx` のモック修正
3. 全テスト再実行 → 全テストPASS

---

## 躓きポイントと解決策

### 1. テスト失敗: 401エラーでエラーがthrowされない

**問題：**
`api.login` が `throw { status: res.status, ...payload } as ApiError;` という形でオブジェクトをthrowしていたため、Jestの `toThrow()` マッチャーが正しく動作しなかった。

**解決：**
Error オブジェクトとして properly にthrow:
```typescript
const error = new Error(errorMessage) as Error & { status: number };
error.status = res.status;
throw error;
```

**学習：**
JavaScriptでは任意の値をthrowできるが、テストやエラーハンドリングの観点からは Error オブジェクトを使用すべき。

### 2. TypeScriptエラー: HeadersInit型のインデックス付け

**問題：**
```typescript
const headers: HeadersInit = { ... };
headers["Authorization"] = `Bearer ${token}`; // エラー
```

**解決：**
`Record<string, string>` 型を使用:
```typescript
const headers: Record<string, string> = { ... };
headers["Authorization"] = `Bearer ${token}`; // OK
```

**学習：**
`HeadersInit` は Union型（`Headers | string[][] | Record<string, string>`）のため、直接インデックス付けできない。具体的な型を使用することで解決。

### 3. page.test.tsx のモック更新

**問題：**
実装を変更したため、テストのモックも更新が必要だった。

**解決：**
- `useAuthStore` のモックに `login`/`register` 関数を追加
- `getState()` メソッドを実装してストアのAPIに合わせた
- テストケースを新しいAPI（`useAuthStore.getState().login()`）に変更

**学習：**
実装を変更した際は、テストも同時に更新する必要がある。TDDサイクルではテストが「仕様書」の役割を果たすため、常に実装と同期させることが重要。

---

## 技術メモ

### 動的インポートで循環参照を回避

```typescript
// 401エラー時は自動ログアウト
if (response.status === 401) {
  // 動的インポートで循環参照を回避
  if (typeof window !== "undefined") {
    const { useAuthStore } = await import("../store/useAuthStore");
    useAuthStore.getState().logout();
  }
  throw new Error("認証が必要です");
}
```

**理由：**
- `api.ts` → `useAuthStore.ts` → `api.ts` の循環参照を避けるため
- SSR/SSG時（window未定義）のエラーを回避

### テーブル駆動テストの例

```typescript
describe("login", () => {
  it("正常系: ログイン成功でトークンとユーザー情報が保存される", async () => {
    const mockResponse = {
      token: "test-token-123",
      user: { id: 1, name: "Test User", email: "test@example.com" },
    };

    global.fetch = jest.fn(() =>
      Promise.resolve({
        ok: true,
        json: async () => mockResponse,
      }) as unknown as Response,
    ) as unknown as typeof global.fetch;

    await useAuthStore.getState().login("test@example.com", "password");

    const state = useAuthStore.getState();
    expect(state.token).toBe("test-token-123");
    expect(state.user).toEqual(mockResponse.user);
    expect(localStorage.getItem("auth_token")).toBe("test-token-123");
  });
});
```

---

## 次回の課題

### 優先度: P0

- **動作確認（手動テスト）**
  - ブラウザでログインフローを確認
  - 商品一覧表示を確認
  - 401エラー時の自動ログアウトを確認

- **フロント実装の残タスク**
  - 商品一覧ページの実装
  - 商品追加ページの実装

### 優先度: P1

- **チケット5: パスワードリセット設計→実装**
  - `SetResetToken` を使用したリセットフロー設計
  - メールテンプレート検討

- **チケット9: 監査ログ（ユーザロール変更）**
  - ロール変更時のログ記録設計

### 優先度: P2

- **チケット6: RefreshToken 方針設計**
  - refresh token の保存方法（DB/Cookie）
  - トークン寿命・盗難対策の検討

---

## 実行コマンド（参考）

```bash
# テスト実行
cd /workspaces/sol_coffeesys/frontend
npm test -- useAuthStore.test.ts
npm test -- api.fetchWithAuth.test.ts
npm test  # 全テスト実行

# コンパイルエラーチェック
npm run build
```

## Git コミットメッセージ（Conventional Commits）

```bash
git add frontend/store/useAuthStore.ts frontend/lib/api.ts frontend/app/login/page.tsx
git commit -m "feat(frontend): integrate auth functions into useAuthStore

- Add login/register methods to useAuthStore for centralized auth logic
- Implement fetchWithAuth for automatic token injection in API calls
- Simplify login page by delegating to store methods
- Add auto-logout on 401 responses for security

BREAKING CHANGE: createProduct signature changed (removed token param)"

git add frontend/lib/__tests__/
git commit -m "test(frontend): add comprehensive auth integration tests

- Add login/register tests in useAuthStore (5 cases)
- Add fetchWithAuth tests with auto token injection (4 cases)
- Update login page tests for new store-based implementation
- All 17 tests passing"

git add doc/task.md
git commit -m "docs(task): mark ticket 8 (frontend auth integration) as completed"
```

---

## 学習ポイント（振り返り）

### 設計の改善点

1. **責任の明確化**
   - 認証ロジックをストアに一元化 → 保守性向上
   - API呼び出しの共通化（`fetchWithAuth`）→ DRY原則

2. **セキュリティの向上**
   - 401エラー時の自動ログアウト → セッション管理の堅牢性向上
   - トークンの自動付与 → 手動付与によるミスを防止

3. **DX（開発者体験）の向上**
   - ログイン処理が1行に → コードの読みやすさ向上
   - トークンを意識しなくてよい → 認証を意識せずに実装可能

### TDDの実践で得た気づき

1. **テストファースト**
   - 先にテストを書くことで、インターフェース設計が明確になった
   - 実装時に「何をテストすべきか」が既に決まっているため、実装に集中できた

2. **リファクタリングの安全性**
   - テストがあることで、型エラー修正時も安心してリファクタリングできた
   - 既存機能の破壊を即座に検知できた（page.test.tsx）

3. **段階的な実装**
   - Red → Green → Refactor のサイクルで、着実に進められた
   - 小さな成功（テストPASS）の積み重ねがモチベーション維持につながった

---

作成日: 2026-02-19
