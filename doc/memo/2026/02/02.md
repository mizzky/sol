# 開発メモ - 2026/02/02

## 🎯 本日の作業目的
- **Phase 1（商品・カテゴリ管理）** の実装を進める
- テストコード駆動開発（TDD）で CRUD API を実装

---

## ✅ 完了した作業

### 1. Migration 実行
- `000003_create_categories_table.up.sql`（カテゴリテーブル作成）
- `000004_alter_products_table.up.sql`（商品テーブル拡張）
  - `category_id`, `sku`, `description`, `image_url`, `stock_quantity` などのカラムを追加
  - 外部キー制約とインデックスを設定

### 2. sqlc クエリ定義 & コード生成
- `backend/query.sql` にカテゴリの CRUD クエリを追加：
  - `CreateCategory`（カテゴリ作成）
  - `GetCategory`（カテゴリ取得）
  - `ListCategories`（カテゴリ一覧）
  - `UpdateCategory`（カテゴリ更新）
  - `DeleteCategory`（カテゴリ削除）
- `sqlc generate` を実行し、Go コードを生成成功

### 3. 環境構築のトラブルシューティング
- Dev Container 内での権限エラー解決（`/go` ディレクトリの所有権修正）
- `golang-migrate` のインストールと設定
- PostgreSQL ドライバ（`github.com/lib/pq`）のインストール
- DB 疎通確認完了

---

### 4. user.go のテストコード設計・実装
- `LoginHandler` のテストケースを追加：
  - 正常系：ログイン成功
  - 異常系：ユーザーが存在しない
  - 異常系：パスワードが間違っている
  - 異常系：JSON形式エラー
  - 異常系：トークン生成エラー
- モックの共通化：`mockdb_test.go` を作成し、`MockDB` と `MockTokenGenerator` を集約
- 依存性注入の導入：`LoginHandler` に `auth.TokenGenerator` を注入し、トークン生成エラーのテストを実現
- テストループの最適化：`setupMock` と `setupTokenMock` を分離し、責務を明確化
- **Commit**: `test: Refactor mocks and add login tests with token generation error handling`

---

## 🔄 次のステップ

### 優先度1：`RegisterHandler` のテストコード作成
- `RegisterHandler` のテストケースを作成

### 優先度2：カテゴリ一覧/更新/削除のハンドラー実装
- `GET /api/categories`、`PUT /api/categories/:id`、`DELETE /api/categories/:id` を実装

### 優先度3：商品管理 CRUD API
- カテゴリと同様の手順で商品管理 API を実装

### 優先度4：管理者ミドルウェア
- `AdminOnly()` ミドルウェアを実装し、管理者権限が必要なエンドポイントに適用

---

## 📌 技術的な決定事項

- **Migration 実行方法**: Go スクリプト（`cmd/migrate/main.go`）を使用する案もあったが、最終的に `migrate` CLI で実行
- **開発手法**: テストコード駆動開発（TDD）
- **テスト方針**: HTTPモックを使った単体テスト（推奨）
- **モック管理**: `mockdb_test.go` に共通モックを集約し、テストの責務分離を実現
- **依存性注入**: トークン生成のテストを可能にするため、`LoginHandler` に `auth.TokenGenerator` を注入