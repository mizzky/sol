# 2026-02-18 チケット4作業記録

## 本日取り組んだタスク

**チケット4「ユーザ関連の sqlc クエリとテスト整備」** の実装完了

### 実装内容

#### 1. query.sql にクエリ追加
```sql
-- name: GetUserByID :one
SELECT * FROM users WHERE id = $1 LIMIT 1;

-- name: UpdateUserRole :one
UPDATE users
SET role = @role,
    updated_at = NOW()
WHERE id = @id
RETURNING *;

-- name: SetResetToken :one
UPDATE users
SET reset_token = @reset_token,
    updated_at = NOW()
WHERE id = @id
RETURNING *;
```

#### 2. sqlc generate で生成物更新
- `db/models.go`: `User` 構造体に `ResetToken *string` フィールドが自動追加
- `db/query.sql.go`: 新クエリ関数 `GetUserByID()`、`UpdateUserRole()`、`SetResetToken()` を生成
- `db/querier.go`: インターフェースに新メソッド追加

#### 3. テスト層実装

**handler 層（mock 拡張）**
- `backend/handler/testutil/mockdb.go` に3つの新メソッド追加
- `backend/auth/middleware_test.go` の `FakeQuerier` / `BadQuerier` に実装：
  - `GetUserByID()`: ID でユーザー取得（フェイク）
  - `UpdateUserRole()`: ロール変更（フェイク）
  - `SetResetToken()`: トークン保存（フェイク）

**db 層（単体テスト：sqlmock ベース）**
- `backend/db/query_user_test.go` をテーブル駆動テストで実装
- **GetUserByID**: 2ケース
  - ✅ 正常系：既存ユーザーを ID で取得
  - ✅ 異常系：存在しないユーザー → `sql.ErrNoRows`
- **UpdateUserRole**: 2ケース
  - ✅ 正常系：role を admin に更新、updated_at が変更
  - ✅ 異常系：存在しないユーザー → `sql.ErrNoRows`
- **SetResetToken**: 3ケース
  - ✅ 正常系：トークンを保存
  - ✅ 正常系：トークンを NULL でクリア
  - ✅ 異常系：存在しないユーザー → `sql.ErrNoRows`

#### 4. テスト実行結果
```
✅ go test ./db -v: 全 7ケース PASS
✅ go test ./...: 全テスト PASS
```

#### 5. ドキュメント更新
- `doc/dev.md` に「sqlc 再生成の詳細手順」を追記
  - query.sql にクエリ追加後の手順を明文化
  - 生成物確認の具体的チェックリスト記載

---

## 躓きポイントと解決策

### 1. 統合テストか単体テストか迷った
**問題**: 最初、実 DB を使った統合テストを提案してしまい、devcontainer 内での DB 接続設定で時間がかかった。

**解決**: ユーザー指示を再確認し、**TDD チケット4 は単体テスト（sqlmock）が正解** と判断。統合テストは不要と結論。

**学習**: ユーザー指示に明記されていた「TDD」「テスト設計」を最初から参照すべきだった。

### 2. devcontainer から WSL 上のコンテナへの接続失敗
**問題**: `localhost:5433` では接続拒否 → `connection refused`

**解決**: ゲートウェイ IP を使用：
```bash
HOST_IP=$(ip route | awk '/default/ {print $3}')
export TEST_DB_DSN="postgresql://test:test@${HOST_IP}:5433/sol_test?sslmode=disable"
```

### 3. コンパイルエラーの連鎖（auth テスト）
**問題**: 新規クエリの追加により、`FakeQuerier` / `BadQuerier` が `db.Querier` インターフェースを実装していないエラー。

**解決**: `backend/auth/middleware_test.go` 内の 2つのフェイク名に新メソッドを追加。

**気づき**: モック/フェイクの定義位置を特定するのに時間がかかった。最初から `grep -r "type FakeQuerier"` で検索すべき。

### 4. sqlmock での SQL 文字列マッチング
**問題**: sqlmock が期待する SQL 文字列を正確に指定する必要があったが、生成コード内の const を参照する方法が不明確だった。

**解決**: `regexp.QuoteMeta()` で生成コード内の const （例: `getUserByID`）を参照してテスト。

---

## 技術メモ

### sqlmock ベースの テーブル駆動テスト

```go
func setupMock(t *testing.T) (*db.Queries, sqlmock.Sqlmock, func()) {
    sqlDB, mock, err := sqlmock.New()
    require.NoError(t, err)
    q := db.New(sqlDB)
    cleanup := func() { sqlDB.Close() }
    return q, mock, cleanup
}

// テストケース定義
tests := []struct {
    name      string
    mockSetup func(sqlmock.Sqlmock)
    expectedErr bool
}{...}

// テスト実行
for _, tt := range tests {
    t.Run(tt.name, func(t *testing.T) {
        q, mock, cleanup := setupMock(t)
        defer cleanup()
        
        tt.mockSetup(mock) // 期待値設定
        
        // 実装を呼び出し
        result, err := q.GetUserByID(ctx, id)
        
        // アサーション
        assert.NoError(t, mock.ExpectationsWereMet())
    })
}
```

### sqlc クエリ追加後の確認チェックリスト
1. query.sql にクエリ追加 → `-- name: [func name] :[one|many|exec]` コメント必須
2. sqlc generate 実行
3. models.go / query.sql.go / querier.go 確認（新フィールド/関数が生成されたか）
4. go test ./db で単体テスト実行
5. go test ./... で全テスト実行
6. git add で生成物をコミット対象に含める

---

## 次回の課題

- **チケット2**（ロール管理API: SetUserRoleHandler 実装）
  - handler 層で UpdateUserRole を呼び出す実装
  - 管理者のみが実行可能の検証（auth.AdminOnly ミドルウェア）
  
- **チケット5**（パスワードリセット設計→実装候補）
  - SetResetToken を使用したリセットフロー設計
  - メールテンプレート検討

- **統合テスト**（将来的に必要に応じて）
  - 単体テストでカバーできない e2e ケースの検証

---

## 実行コマンド（参考）
```bash
cd backend
go get github.com/DATA-DOG/go-sqlmock@latest
sqlc generate
go test ./db -v
go test ./...
```

## コミットメッセージ（Conventional Commits）
```
feat(db): add GetUserByID, UpdateUserRole, SetResetToken sqlc queries
test(db): add table-driven unit tests for user queries with sqlmock
test(auth): implement GetUserByID in FakeQuerier and BadQuerier
docs(dev): add sqlc regeneration detailed procedure
```
