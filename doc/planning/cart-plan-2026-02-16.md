# カート機能 — チケット詳細（作成日: 2026-02-16）

目的
- ユーザのカートをサーバ側で永続化し、Checkout での整合性を担保する。

受け入れ基準
- `carts` と `cart_items` のマイグレーションが存在する。  
- API でアイテム追加/更新/削除/取得が行える。  
- Checkout 呼び出しで在庫不足時はエラーを返す。

チケット一覧

1) 要件決定: 在庫確保タイミング — Effort: Low, Priority: P0
   - 内容: AddToCart 時点で在庫を確保するか、Checkout 時に確認するかを決定（ドキュメント化）。  
   - 影響ファイル: doc/planning, backend/handler/cart.go
   - 受け入れ条件: 選択と理由がドキュメントに記載されていること。

2) DBマイグレーション: `carts`, `cart_items` — Effort: Med, Priority: P0
   - 内容: `carts(id, user_id, created_at, updated_at)`、`cart_items(id, cart_id, product_id, quantity, price)` のマイグレーション作成。  
   - 影響ファイル: backend/db/migrations, backend/query.sql
   - 受け入れ条件: マイグレーションファイルが追加され、手動適用手順が記載されていること。

3) sqlc クエリ追加 — Effort: Med, Priority: P0
   - 内容: `CreateCart`, `GetCartByUser`, `AddCartItem`, `UpdateCartItemQty`, `RemoveCartItem`, `ClearCart` を追加。  
   - 影響ファイル: backend/query.sql, backend/db/querier.go
   - 受け入れ条件: sqlc 再生成手順とサンプル呼び出しがドキュメント化されていること。

4) API ハンドラ実装（サーバ） — Effort: Med, Priority: P0
   - 内容: `GET /me/cart`, `POST /me/cart/items`, `PATCH /me/cart/items/:id`, `DELETE /me/cart/items/:id`, `DELETE /me/cart` を実装。  
   - 影響ファイル: backend/handler/cart.go (新規), backend/routes/routes.go
   - 受け入れ条件: 主要なエンドポイントのユニットテストがあること。

5) 所有権/認可チェック — Effort: Low, Priority: P0
   - 内容: カート操作は必ずログインユーザのカートのみ許可する。  
   - 影響ファイル: backend/auth/middleware.go, backend/handler/cart.go
   - 受け入れ条件: ユニットテストで他ユーザの操作が403になること。

6) カートマージ（ログイン時） — Effort: Med, Priority: P1
   - 内容: ローカルの匿名カートをログイン時にユーザの `carts` とマージするロジック。数量合算や重複制御を定義。  
   - 影響ファイル: frontend/store/useCartStore.ts, backend/handler/cart.go
   - 受け入れ条件: マージシナリオのユニットテストがあること。

7) フロント: `useCartStore` と API 統合 — Effort: Low, Priority: P0
   - 内容: カートストア作成、Add/Remove/Sync メソッド、ログイン時のマージ呼び出しを実装。  
   - 影響ファイル: frontend/store/useCartStore.ts (新規), frontend/lib/api.ts
   - 受け入れ条件: フロント単体テストで基本操作がモックAPIで動く。

8) Checkout 連携設計 — Effort: Med, Priority: P0
   - 内容: `POST /orders`（または `/checkout`）を呼んでカートを注文に変換するフローを定義。エラー時のロールバック仕様含む。  
   - 影響ファイル: backend/handler/order.go, frontend/lib/api.ts
   - 受け入れ条件: フロー図とエラーケース一覧がdocにあること。

9) テスト: 在庫不足・同時更新ケース — Effort: Med, Priority: P1
   - 内容: Checkout の統合テストで在庫不足時に適切なエラーを返すことを検証。並列実行での競合ケースを作成。  
   - 影響ファイル: backend/tests, frontend/__tests__

実施順の推奨
1→2→3→4→5→7→6→8→9
